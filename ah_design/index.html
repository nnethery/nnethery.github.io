<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Action Plan – Markdown Support</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    :root {
      --primary-color: #00A699;
      --primary-color-light: #e0f2f1;
      --light-gray: #f0f0f0;
      --medium-gray: #ccc;
      --dark-gray: #666;
      --text-color: #333;
      --background-color: #f7f7f7;
      --card-background: #ffffff;
      --link-color: #007bff;
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0; background: var(--background-color); color: var(--text-color);
    }
    .page-wrapper { display: flex; justify-content: center; align-items: center; flex-direction: column; min-height: 100vh; padding: 20px 0; }
    .main-container { width: 90%; max-width: 650px; padding: 30px 40px; background: var(--card-background); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); text-align: center; }
    .retest-banner { display: flex; align-items: center; justify-content: center; background: var(--primary-color-light); color: var(--primary-color); padding: 12px 20px; border-radius: 12px; margin-bottom: 24px; font-weight: 500; font-size: 15px; }
    .retest-banner svg { margin-right: 12px; fill: var(--primary-color); }
    h1 { font-size: 26px; font-weight: 600; margin: 0 0 8px; color: #222; }
    select {
      -webkit-appearance: none; appearance: none; background: var(--light-gray);
      border: none; padding: 12px 40px 12px 16px; font-size: 16px; border-radius: 12px;
      cursor: pointer; width: 100%; max-width: 350px; margin-bottom: 32px;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%3D%22m5%206%205%208%205-8%22%20stroke%3D%22%23666%22%20stroke-width%3D%221.5%22%20fill%3D%22none%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22/%3E%3C/svg%3E');
      background-repeat: no-repeat; background-position: right 12px center;
    }
    select:focus { outline: 2px solid var(--primary-color); }
    .chart-container { position: relative; margin-top: 24px; }
    #healthChart { cursor: pointer; }
    .chart-overlay {
      position: absolute; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.6); backdrop-filter: blur(1px);
    }
    .chart-overlay .take-test-btn {
      pointer-events: auto; padding: 12px 18px; border-radius: 999px; border: 0; font-weight: 600; font-size: 16px;
      background: linear-gradient(180deg, #00A699, #009688); color: #fff; box-shadow: 0 6px 20px rgba(0,0,0,0.15); cursor: pointer;
    }
    .summary-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; margin: 32px 0; text-align: left; }
    .summary-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .summary-card h2 { margin: 0; font-size: 18px; color: var(--text-color); }
    .summary-card p { margin-bottom: 0; line-height: 1.6; color: var(--dark-gray); }
    .accordion-container { text-align: left; width: 100%; }
    .accordion-item { border-bottom: 1px solid #e9ecef; }
    .accordion-item:last-child { border-bottom: none; }
    .accordion-item summary {
      padding: 20px 8px 20px 0;
      font-size: 16px; font-weight: 500; cursor: pointer;
      list-style: none; display: flex; justify-content: space-between; align-items: center;
    }
    .accordion-item summary::-webkit-details-marker { display: none; }
    .accordion-item summary::after { content: '▼'; font-size: 12px; color: var(--medium-gray); transition: transform 0.2s ease-in-out; }
    .accordion-item[open] > summary::after { transform: rotate(180deg); }
    .accordion-content { padding-bottom: 24px; }
    .accordion-content h3 { font-size: 14px; color: var(--text-color); margin-bottom: 8px; }
    .accordion-content p, .accordion-content ul { font-size: 15px; color: var(--dark-gray); line-height: 1.6; margin-top: 0; }
    .accordion-content ul { padding-left: 20px; list-style-type: disc; }
    .accordion-content li { margin-bottom: 8px; }
    .importance-badge { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 12px; margin-left: auto; flex-shrink: 0; color: #fff; }
    .badge-most { background-color: #dc3545; } .badge-mod { background-color: #ffc107; color: #333; } .badge-least { background-color: #28a745; }
    .source-button {
      background-color: var(--light-gray); color: var(--dark-gray); border: none;
      padding: 6px 12px; font-size: 12px; font-weight: 500; border-radius: 8px;
      cursor: pointer; transition: background-color 0.2s;
    }
    .source-button:hover { background-color: #e2e6ea; }
    .source-link { font-size: 12px; color: var(--link-color); cursor: pointer; text-decoration: none; margin-left: 8px; font-weight: 500; }
    .source-link:hover { text-decoration: underline; }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-drawer {
      position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-background); z-index: 1001;
      border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); padding: 24px;
      transform: translateY(100%); transition: transform 0.3s ease-out; max-height: 70vh; overflow-y: auto; box-sizing: border-box;
    }
    .modal-overlay.show .modal-drawer { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-header h2 { margin: 0; font-size: 20px; }
    .modal-close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--medium-gray); line-height: 1; }
    .source-list-item { margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 16px; }
    .source-list-item:last-child { border-bottom: none; margin-bottom: 0; }
    .source-list-item p { margin: 0 0 4px 0; font-size: 16px; font-weight: 500; }
    .source-list-item a { color: var(--link-color); text-decoration: none; font-size: 14px; }
    .source-list-item a:hover { text-decoration: underline; }
    .update-timestamp { margin-top: 32px; font-size: 13px; color: var(--dark-gray); font-style: italic; }
    .muted { color: var(--dark-gray); font-size: 14px; }

    /* Basic styling for rendered markdown inside accordion/modal */
    .markdown p { margin: 0 0 10px; }
    .markdown ul { margin: 8px 0 10px 22px; }
    .markdown ol { margin: 8px 0 10px 22px; }
    .markdown code { background: #f2f2f2; padding: 2px 4px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .markdown a { color: var(--link-color); text-decoration: none; }
    .markdown a:hover { text-decoration: underline; }

    /* New styles for expandable description */
    .prong-description-area .markdown p:first-of-type { margin-bottom: 4px; }
    .prong-description-area .description-rest.markdown p:first-of-type { margin-top: 8px; }
    .toggle-description {
      background: none; border: none; font-family: inherit;
      color: var(--link-color); cursor: pointer; padding: 0;
      font-size: 14px; font-weight: 500;
    }
    .toggle-description:hover { text-decoration: underline; }
    .edu-sources-wrapper { margin-top: 12px; }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="main-container">
      <div class="retest-banner" id="retest-banner">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M220-100q-24 0-42-18t-18-42v-580q0-24 18-42t42-18h520q24 0 42 18t18 42v580q0 24-18 42t-42 18H220Zm0-60h520v-580H220v580Zm0 0v-580 580Zm260-250q-17 0-28.5-11.5T440-450v-170q0-17 11.5-28.5T480-660q17 0 28.5 11.5T520-620v170q0 17-11.5 28.5T480-410Z"/></svg>
        <span>Recommended re-test: December 5, 2025</span>
      </div>

      <h1 id="main-title">Therapy Plan</h1>

      <select id="state-selector">
        <option value="NEW" selected>New User - No test data</option>
        <option value="POTS">Postural Orthostatic Tachycardia (POTS)</option>
        <option value="CAN">Cardiovascular Autonomic Neuropathy (CAN)</option>
      </select>

      <div class="chart-container">
        <canvas id="healthChart"></canvas>
        <div id="chart-overlay" class="chart-overlay">
          <button class="take-test-btn" type="button" aria-label="Take ANS Test">Take ANS Test</button>
        </div>
      </div>

      <div class="summary-card" id="summary-card">
        <div class="summary-card-header">
          <h2 id="summary-title">Indications</h2>
          <button id="main-source-button" class="source-button">View Sources</button>
        </div>
        <p id="summary-text">Your data shows patterns of Sympathetic Withdrawal (SW). Your plan prioritizes Anti-inflammatory and Diet therapies to heal nerves, along with specialized Exercise.</p>
      </div>

      <div id="accordion-container" class="accordion-container"></div>

      <p class="update-timestamp" id="update-stamp">Plan last updated on: <span id="last-updated-date"></span></p>
    </div>
  </div>

  <div id="source-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-drawer" role="dialog" aria-modal="true" aria-labelledby="sources-title">
      <div class="modal-header">
        <h2 id="sources-title">Sources</h2>
        <button id="modal-close-btn" class="modal-close-btn" aria-label="Close">&times;</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
    // ---- Utilities: safe Markdown rendering ----
    function renderMarkdown(md) {
      try {
        if (window.marked && window.DOMPurify) {
          return DOMPurify.sanitize(marked.parse(md || ''));
        }
      } catch(e) {
        console.warn('Markdown render failed, falling back to plain text.', e);
      }
      // Fallback: escape & simple line breaks
      const div = document.createElement('div');
      div.textContent = md || '';
      return div.innerHTML.replace(/\n/g, '<br />');
    }

    // ---- Shared prong labels (must match viz labels) ----
    const baseProngLabels = ['Diet', 'Nitric Oxide', 'Antioxidants', 'Anti-inflammatory', 'Exercise', 'Stress Reduction'];
    const prongIdMap = baseProngLabels.reduce((acc, label) => {
      acc[label] = 'prong-' + label.toLowerCase().replace(/\s+/g, '-');
      return acc;
    }, {});

    // ---- Mock condition data (unchanged) ----
    const therapyData = {
      'POTS': {
        name: 'Postural Orthostatic Tachycardia (POTS)',
        color: 'rgba(255, 145, 0, 0.4)',
        chartValues: [100, 33, 33, 100, 100, 33],
        summary: "Your data shows patterns of **Sympathetic Withdrawal (SW)**. Your plan prioritizes *Anti-inflammatory* and *Diet* therapies to heal nerves, along with specialized Exercise.",
        sources: [
          { title: "Postural Tachycardia Syndrome: A Heterogeneous and Multifactorial Disorder", doi: "10.1016/j.mayocp.2013.01.004", url: "https://www.mayoclinicproceedings.org/article/S0025-6196(13)00063-9/fulltext" },
          { title: "The role of inflammation in POTS", doi: "10.1111/j.1540-8167.2008.01344.x", url: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2758320/" },
        ],
        prongOrder: ['Anti-inflammatory', 'Diet', 'Exercise', 'Nitric Oxide', 'Antioxidants', 'Stress Reduction'],
        protocols: {
          'Anti-inflammatory': { definition: "Reducing systemic inflammation helps your nerves heal and function more effectively.", actions: [ { text: "Take **r-Alpha-Lipoic Acid (ALA)**: 600 mg, three times a day.", sources: [{ title: "Alpha-lipoic acid in the treatment of diabetic peripheral and cardiac autonomic neuropathy", doi: "10.2165/00003495-199958001-00007", url: "#" }] } ] },
          'Diet': { definition: "Proper hydration and nutrients are critical for maintaining blood volume and providing energy.", actions: [ { text: "Hydration with **Electrolytes**: Drink 64–96 oz of water daily with added salt.", sources: [{ title: "Water and Sodium Intake in Postural Tachycardia Syndrome", doi: "10.1161/JAHA.119.011608", url: "#" }] } ] },
          'Exercise': { definition: "Specific exercises can retrain your nervous system.", actions: [ { text: "Low-and-Slow Exercise: Begin with *supine* exercises.", sources: [{ title: "Exercise vs propranolol in POTS", url: "#"}] } ] },
          'Nitric Oxide': { definition: "Supports healthy blood flow.", actions: [ { text: "Consider a nitric oxide booster like **beet root extract** powder (500–1000 mg daily).", sources: [] } ] },
          'Antioxidants': { definition: "Help protect your nerves from ongoing stress and damage.", actions: [ { text: "Supplement with **CoQ10** (200 mg daily).", sources: [] } ] },
          'Stress Reduction': { definition: "Manages the sympathetic response triggered by POTS.", actions: [ { text: "Practice calming breathing techniques.", sources: [] } ] }
        }
      },
      'CAN': {
        name: 'Cardiovascular Autonomic Neuropathy (CAN)',
        color: 'rgba(255, 90, 95, 0.4)',
        chartValues: [100, 33, 33, 100, 100, 100],
        summary: "Your data suggests CAN, where **nerve damage** affects heart function.",
        sources: [ { title: "Cardiovascular Autonomic Neuropathy in Diabetes", doi: "10.2337/dc16-2093", url: "#" } ],
        prongOrder: ['Anti-inflammatory', 'Diet', 'Exercise', 'Antioxidants', 'Stress Reduction', 'Nitric Oxide'],
        protocols: {
          'Anti-inflammatory': { definition: "Aggressively managing inflammation is key.", actions: [ { text: "Take **r-Alpha-Lipoic Acid (ALA)**: 600 mg, three times a day.", sources: [{ title: "Alpha-lipoic acid", url: "#" }] } ] },
          'Diet': { definition: "A proper diet supports nerve regeneration.", actions: [ { text: "Supplement with **methylfolate** (7.5 mg daily).", sources: [] } ] },
          'Exercise': { definition: "Gentle, consistent exercise helps improve circulation.", actions: [ { text: "Follow Low-and-Slow Exercise protocol.", sources: [] } ] },
          'Antioxidants': { definition: "Protect nerves from oxidative stress.", actions: [ { text: "Take **CoQ10** (200 mg daily).", sources: [] } ] },
          'Stress Reduction': { definition: "High stress can worsen autonomic symptoms.", actions: [ { text: "Prioritize 7–9 hours of sleep.", sources: [] } ] },
          'Nitric Oxide': { definition: "Helps maintain vascular health.", actions: [ { text: "Consume nitrate-rich foods like **spinach** and **arugula**.", sources: [] } ] }
        }
      }
    };

    // ---- Chart setup ----
    const ctx = document.getElementById('healthChart').getContext('2d');
    let chartClickable = true;
    const healthChart = new Chart(ctx, {
      type: 'radar',
      data: { labels: baseProngLabels.slice(), datasets: [{ data: [], fill: true }] },
      options: {
        responsive: true, maintainAspectRatio: true,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          r: {
            angleLines: { color: '#e0e0e0' }, grid: { color: '#e9e9e9' },
            pointLabels: { font: { size: 13, weight: 500 }, color: '#555' },
            ticks: {
              backdropColor: 'rgba(255,255,255,0.75)', color: '#888', stepSize: 33,
              callback: (value)=>({100:'Most Important',67:'Moderately',33:'Least Important'}[Math.round(value)]||'')
            },
            min: 0, max: 100
          }
        },
        onClick: (evt, elements, chart) => {
          if (!chartClickable) return;
          if (elements.length > 0) {
            const idx = elements[0].index;
            const label = chart.data.labels[idx];
            const target = document.getElementById(prongIdMap[label]);
            if (target) {
              document.querySelectorAll('.accordion-item[open]').forEach(el => { if (el.id !== prongIdMap[label]) el.removeAttribute('open'); });
              target.setAttribute('open','');
              target.scrollIntoView({behavior:'smooth', block:'start'});
            }
          }
        }
      }
    });

    // ---- DOM elements ----
    const selector = document.getElementById('state-selector');
    const accordionContainer = document.getElementById('accordion-container');
    const mainSourceButton = document.getElementById('main-source-button');
    const modal = document.getElementById('source-modal');
    const modalContent = document.getElementById('modal-content');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const lastUpdatedDateEl = document.getElementById('last-updated-date');
    const updateStamp = document.getElementById('update-stamp');
    const summaryCard = document.getElementById('summary-card');
    const retestBanner = document.getElementById('retest-banner');
    const chartOverlay = document.getElementById('chart-overlay');

    function openModal(sources) {
      modalContent.innerHTML = '';
      if (sources && sources.length) {
        sources.forEach(src => {
          // Allow either structured refs or raw markdown strings
          if (typeof src === 'string') {
            const html = renderMarkdown(src);
            modalContent.insertAdjacentHTML('beforeend', `<div class="source-list-item markdown">${html}</div>`);
          } else {
            const title = src.title || src.study_name || 'Reference';
            const href = src.url || src.link || '#';
            const doi = src.doi ? ('DOI: ' + src.doi) : '';
            modalContent.insertAdjacentHTML('beforeend', `
              <div class="source-list-item">
                <p>${title}</p>
                <a href="${href}" target="_blank" rel="noopener noreferrer">${doi || 'Open'}</a>
              </div>`);
          }
        });
      } else {
        modalContent.innerHTML = '<p class="muted">No sources available.</p>';
      }
      document.body.classList.add('modal-open'); modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){ document.body.classList.remove('modal-open'); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
    modal.addEventListener('click', (e)=>{ if (e.target === modal || e.target === modalCloseBtn) closeModal(); });

    function shuffle(arr){ const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
    function randomValues(n){ const choices=[33,67,100]; return Array.from({length:n},()=>choices[Math.floor(Math.random()*choices.length)]); }

    // ---- JSON: prongs education content ----
    let prongsJson = [];
    let prongsByName = {};
    async function loadProngsJson() {
      try {
        const res = await fetch('prongs.json', { cache: 'no-store' });
        prongsJson = await res.json();
        prongsByName = prongsJson.reduce((acc, item) => {
          if (item && item.name) acc[item.name.trim().toLowerCase()] = item;
          return acc;
        }, {});
      } catch (e) {
        console.warn('Failed to load prongs.json', e);
        prongsJson = [];
        prongsByName = {};
      }
    }

    // ---- Builders ----
    function buildProngDescriptionArea(prongName) {
      const pr = prongsByName[prongName.toLowerCase().trim()];
      // Use definition from therapyData as a fallback for condition states
      const stateInfo = therapyData[selector.value];
      const definitionFromProtocol = stateInfo?.protocols?.[prongName]?.definition;
      const description = pr?.description || definitionFromProtocol || 'Description unavailable.';
      
      const parts = description.split('\n');
      const preview = parts[0];
      const rest = parts.slice(1).join('\n');
      
      const hasRefs = pr && Array.isArray(pr.references) && pr.references.length > 0;
      const sourceButtonHTML = hasRefs
        ? `<button class="source-button edu-source" data-prong-name="${encodeURIComponent(prongName)}">View Sources</button>`
        : `<p class="muted">No general sources provided.</p>`;

      if (!rest.trim()) {
        return `
          <div class="prong-description-area">
            <div class="description-preview markdown">${renderMarkdown(preview)}</div>
            <div class="edu-sources-wrapper">${sourceButtonHTML}</div>
          </div>`;
      }

      return `
        <div class="prong-description-area" data-expanded="false">
          <div class="description-preview markdown">${renderMarkdown(preview)}</div>
          <div class="description-rest markdown" style="display: none;">${renderMarkdown(rest)}</div>
          <button type="button" class="toggle-description">... show more</button>
          <div class="edu-sources-wrapper" style="display: none;">${sourceButtonHTML}</div>
        </div>`;
    }

    function buildEducationAccordionFromJson() {
      accordionContainer.innerHTML = '';
      baseProngLabels.forEach(label => {
        const descriptionAreaHTML = buildProngDescriptionArea(label);
        const detailsHTML = `
          <details class="accordion-item" id="${prongIdMap[label]}">
            <summary><span>${label}</span></summary>
            <div class="accordion-content">${descriptionAreaHTML}</div>
          </details>`;
        accordionContainer.insertAdjacentHTML('beforeend', detailsHTML);
      });
    }

    function buildConditionAccordion(stateInfo) {
      accordionContainer.innerHTML = '';
      stateInfo.prongOrder.forEach((prongName, prongIndex) => {
        const prongData = stateInfo.protocols[prongName];
        const chartValue = stateInfo.chartValues[baseProngLabels.indexOf(prongName)];
        let importanceLabel = 'Least', importanceClass = 'badge-least';
        if (chartValue > 90) { importanceLabel = 'Most'; importanceClass = 'badge-most'; }
        else if (chartValue > 60) { importanceLabel = 'Moderately'; importanceClass = 'badge-mod'; }
        
        const descriptionAreaHTML = buildProngDescriptionArea(prongName);
        
        const actionsHtml = prongData.actions.map((action, i) => {
          const srcLink = (action.sources && action.sources.length) ? `<a class="source-link" data-prong-index="${prongIndex}" data-action-index="${i}">[sources]</a>` : '';
          const textHTML = renderMarkdown(action.text || '');
          // The .markdown class is now on the parent for consistent styling
          return `<li><span>${textHTML}</span>${srcLink}</li>`;
        }).join('');
        
        const html = `
          <details class="accordion-item" id="${prongIdMap[prongName]}">
            <summary>
              <span>${prongName}</span>
              <span class="importance-badge ${importanceClass}">${importanceLabel} Important</span>
            </summary>
            <div class="accordion-content">
              ${descriptionAreaHTML}
              <br>
              <h3>Recommendations</h3>
              <ul class="markdown">${actionsHtml}</ul>
            </div>
          </details>`;
        accordionContainer.insertAdjacentHTML('beforeend', html);
      });
    }

    // ---- Renderers ----
    function renderNewUser() {
      retestBanner.style.display = 'none';
      summaryCard.style.display = 'none';
      updateStamp.style.display = 'none';
      mainSourceButton.style.display = 'none';
      chartOverlay.style.display = 'flex';

      chartClickable = false;
      const labels = shuffle(baseProngLabels);
      healthChart.data.labels = labels;
      const ds = healthChart.data.datasets[0];
      ds.data = randomValues(labels.length);
      ds.backgroundColor = 'rgba(128,128,128,0.2)';
      ds.borderColor = 'rgba(128,128,128,0.6)';
      ds.pointBackgroundColor = 'rgba(128,128,128,0.8)';
      healthChart.update();

      if (Object.keys(prongsByName).length === 0) {
        accordionContainer.innerHTML = `<p class="muted">Loading patient education…</p>`;
      } else {
        buildEducationAccordionFromJson();
      }
    }

    function renderCondition(stateKey) {
      const stateInfo = therapyData[stateKey];
      retestBanner.style.display = '';
      summaryCard.style.display = '';
      updateStamp.style.display = '';
      mainSourceButton.style.display = '';
      chartOverlay.style.display = 'none';
      chartClickable = true;

      healthChart.data.labels = baseProngLabels.slice();
      const ds = healthChart.data.datasets[0];
      ds.data = stateInfo.chartValues;
      ds.backgroundColor = stateInfo.color;
      ds.borderColor = stateInfo.color.replace('0.4','1');
      ds.pointBackgroundColor = stateInfo.color.replace('0.4','1');
      healthChart.update();

      document.getElementById('summary-title').textContent = 'Indications';
      document.getElementById('summary-text').innerHTML = renderMarkdown(stateInfo.summary || '');
      buildConditionAccordion(stateInfo);
    }

    function updateDisplay() {
      const selected = selector.value;
      if (selected === 'NEW') renderNewUser();
      else renderCondition(selected);
    }

    // ---- Events ----
    selector.addEventListener('change', updateDisplay);
    document.getElementById('main-source-button').addEventListener('click', () => {
      const st = selector.value;
      if (st === 'NEW') return;
      openModal(therapyData[st].sources);
    });
    accordionContainer.addEventListener('click', (e) => {
      // Handle recommendation source links
      if (e.target.classList.contains('source-link')) {
        const st = selector.value;
        const pIdx = e.target.dataset.prongIndex;
        const aIdx = e.target.dataset.actionIndex;
        const prongName = therapyData[st].prongOrder[pIdx];
        const sources = therapyData[st].protocols[prongName].actions[aIdx].sources;
        openModal(sources);
      }
      // Handle general education source buttons
      if (e.target.classList.contains('edu-source')) {
        const prongName = decodeURIComponent(e.target.dataset.prongName || '');
        const pr = prongsByName[prongName.toLowerCase()];
        openModal(pr?.references || []);
      }
      // Handle description toggle button
      if (e.target.classList.contains('toggle-description')) {
        const button = e.target;
        const wrapper = button.closest('.prong-description-area');
        if (!wrapper) return;

        const isExpanded = wrapper.dataset.expanded === 'true';
        const restContent = wrapper.querySelector('.description-rest');
        const sourcesWrapper = wrapper.querySelector('.edu-sources-wrapper');

        if (isExpanded) {
          if (restContent) restContent.style.display = 'none';
          if (sourcesWrapper) sourcesWrapper.style.display = 'none';
          button.textContent = '... show more';
          wrapper.dataset.expanded = 'false';
        } else {
          if (restContent) restContent.style.display = 'block';
          if (sourcesWrapper) sourcesWrapper.style.display = 'block';
          button.textContent = '... show less';
          wrapper.dataset.expanded = 'true';
        }
      }
    });

    // ---- Init ----
    (async function init() {
      lastUpdatedDateEl.textContent = new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
      await loadProngsJson();
      updateDisplay();
      // If JSON arrived later and we're still in NEW mode, ensure content renders
      document.addEventListener('readystatechange', () => {
        if (document.readyState === 'complete' && selector.value === 'NEW' && accordionContainer.innerHTML.includes('Loading patient education')) {
          buildEducationAccordionFromJson();
        }
      });
    })();
  </script>
</body>
</html>