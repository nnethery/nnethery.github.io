<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chrono Image Game</title>
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    /* Timeline styles */
    .timeline {
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    .timeline-image {
      flex: 0 0 auto;
      margin-right: 10px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .timeline-image.selected {
      border-color: #007bff;
    }
    .timeline-image img {
      max-height: 150px;
      display: block;
    }
  </style>
</head>
<body>
  <!-- Loading indicator -->
  <div
    id="loading"
    class="d-flex justify-content-center align-items-center"
    style="height: 100vh;"
  >
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Game container -->
  <div id="gameContainer" class="container" style="display: none;">
    <h1 class="mt-3">Chrono Image Game</h1>
    <div id="result" class="alert" style="display: none;"></div>
    <div id="timeline" class="timeline"></div>
    <div class="mb-3">
      <button type="button" id="swapBtn" class="btn btn-primary" disabled>
        Swap
      </button>
      <button type="button" id="submitBtn" class="btn btn-success">
        Submit
      </button>
      <button type="button" id="resetBtn" class="btn btn-secondary">
        Reset
      </button>
    </div>
  </div>

  <!-- jQuery, Bootstrap JS Bundle, and Exif.js -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <script>
    $(document).ready(function () {
      // *** CONFIGURATION: update these to match your public S3 bucket ***
      var S3_BUCKET = "vday";
    var S3_PREFIX = "images/";
    var S3_BASE_URL = "https://s3.nethery.dev/vday/"; 
    var bucketListUrl = S3_BASE_URL + "?list-type=2&prefix=" + S3_PREFIX;

      // --- Game Variables ---
      var imagesData = []; // objects: { key, url, dateTaken }
      var correctOrder = []; // array of keys sorted by dateTaken
      var currentOrder = []; // current order (array of keys)
      var selectedIndices = []; // indices of currently selected images

      // Utility: shuffle an array (Fisherâ€“Yates)
      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      // Render the timeline using currentOrder
      function renderTimeline() {
        var timelineDiv = $("#timeline");
        timelineDiv.empty();
        currentOrder.forEach(function (key, index) {
          var imgObj = imagesData.find((obj) => obj.key === key);
          var imgElem = $("<img>")
            .attr("src", imgObj.url)
            .attr("alt", "Image");
          var divElem = $("<div>")
            .addClass("timeline-image")
            .attr("data-index", index)
            .attr("data-key", key);
          divElem.append(imgElem);
          timelineDiv.append(divElem);
        });
        bindImageClick();
      }

      // Bind click events to timeline images
      function bindImageClick() {
        $(".timeline-image").click(function () {
          $(this).toggleClass("selected");
          // Update selectedIndices based on data-index values
          selectedIndices = [];
          $(".timeline-image.selected").each(function () {
            selectedIndices.push(parseInt($(this).attr("data-index")));
          });
          $("#swapBtn").prop("disabled", selectedIndices.length !== 2);
        });
      }

      // Swap the two selected images in currentOrder
      $("#swapBtn").click(function () {
        if (selectedIndices.length === 2) {
          var idx1 = selectedIndices[0];
          var idx2 = selectedIndices[1];
          var temp = currentOrder[idx1];
          currentOrder[idx1] = currentOrder[idx2];
          currentOrder[idx2] = temp;
          renderTimeline();
          selectedIndices = [];
          $("#swapBtn").prop("disabled", true);
        }
      });

      // Check the order on Submit button click
      $("#submitBtn").click(function () {
        if (JSON.stringify(currentOrder) === JSON.stringify(correctOrder)) {
          $("#result")
            .removeClass("alert-danger")
            .addClass("alert-info")
            .text("You Win!")
            .show();
        } else {
          $("#result")
            .removeClass("alert-info")
            .addClass("alert-danger")
            .text("Incorrect")
            .show();
        }
      });

      // Reset the game: reshuffle the images
      $("#resetBtn").click(function () {
        $("#result").hide();
        currentOrder = shuffle([...correctOrder]); // shuffle a copy of correctOrder
        renderTimeline();
      });

      // Process an image to extract its EXIF date
      function processImage(key, url, callback) {
        var img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = function () {
          EXIF.getData(img, function () {
            var dt =
              EXIF.getTag(this, "DateTimeOriginal") ||
              EXIF.getTag(this, "DateTime") ||
              "9999:12:31 23:59:59";
            callback({ key: key, url: url, dateTaken: dt });
          });
        };
        img.onerror = function () {
          callback({ key: key, url: url, dateTaken: "9999:12:31 23:59:59" });
        };
        img.src = url;
      }

      // Fetch the S3 bucket listing (expects XML)
      $.ajax({
        url: bucketListUrl,
        type: "GET",
        dataType: "xml",
        success: function (data) {
          var keys = [];
          $(data)
            .find("Contents")
            .each(function () {
              var key = $(this).find("Key").text();
              // Skip folders (keys ending with '/')
              if (key.slice(-1) === "/") return;
              // Only include images (jpg, jpeg, png)
              if (key.match(/\.(jpg|jpeg|png)$/i)) {
                keys.push(key);
              }
            });
          if (keys.length === 0) {
            $("#loading").html("<p>No images found in bucket.</p>");
            return;
          }
          var processedCount = 0;
          keys.forEach(function (key) {
            var url = S3_BASE_URL + key;
            processImage(key, url, function (imgData) {
              imagesData.push(imgData);
              processedCount++;
              if (processedCount === keys.length) {
                // All images processed: determine correct order (sorted by dateTaken)
                imagesData.sort(function (a, b) {
                  return a.dateTaken.localeCompare(b.dateTaken);
                });
                correctOrder = imagesData.map(function (img) {
                  return img.key;
                });
                // Randomize the initial game order
                currentOrder = shuffle([...correctOrder]);
                renderTimeline();
                $("#loading").hide();
                $("#gameContainer").show();
              }
            });
          });
        },
        error: function () {
          $("#loading").html("<p>Error loading images from S3 bucket.</p>");
        },
      });
    });
  </script>
</body>
</html>
